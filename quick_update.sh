#!/bin/bash

echo "โก Sirius Group - ะััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต"
echo "==================================="

# 1. ะััะฐะฝะพะฒะบะฐ ัะตัะฒะตัะฐ
echo "๐ 1. ะััะฐะฝะพะฒะบะฐ ัะตัะฒะตัะฐ..."
pkill -f uvicorn
sleep 2

# 2. ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ
echo "๐ 2. ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ..."
git stash
git pull origin master

# 3. ะะบัะธะฒะฐัะธั ะพะบััะถะตะฝะธั
echo "๐ 3. ะะบัะธะฒะฐัะธั ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# 4. ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ 4. ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -r requirements.txt

# 5. ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน
echo "๐ 5. ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน..."
alembic upgrade head

# 6. ะะฐะฟััะบ ัะตัะฒะตัะฐ
echo "๐ 6. ะะฐะฟััะบ ัะตัะฒะตัะฐ..."
nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &

# 7. ะัะพะฒะตัะบะฐ
echo "๐ 7. ะัะพะฒะตัะบะฐ ััะฐัััะฐ..."
sleep 3
if pgrep -f "uvicorn" > /dev/null; then
    echo "โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!"
    echo "๐ ะกะฐะนั: http://185.239.50.157:8000"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ"
    echo "๐ ะะพะณ: tail -f server.log"
fi

echo "==================================="
