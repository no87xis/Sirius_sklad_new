#!/bin/bash

echo "üöÄ Sirius Group - –ò–î–ï–ê–õ–¨–ù–ê–Ø –ü–û–õ–ù–ê–Ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
echo "======================================================"
echo "‚úÖ –í–°–ï —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∞–π—Ç–∞: —Å–∫–ª–∞–¥, –º–∞–≥–∞–∑–∏–Ω, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, QR-–∫–æ–¥—ã"
echo "======================================================"

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo "üìã 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f uvicorn
pkill -f python
sleep 3

# 2. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ nginx
echo "üìã 2. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ nginx..."
sudo systemctl reload nginx 2>/dev/null || true
sudo rm -rf /var/cache/nginx/* 2>/dev/null || true

# 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "üìã 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "Sirius_sklad_new/sirius_sklad.db" ]; then
    cp Sirius_sklad_new/sirius_sklad.db sirius_sklad_backup_$(date +%Y%m%d_%H%M%S).db
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"
fi

# 4. –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê
echo "üìã 4. –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê..."
rm -rf Sirius_sklad_new
echo "‚úÖ –°—Ç–∞—Ä–∞—è –ø–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞"

# 5. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å GitHub
echo "üìã 5. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å GitHub..."
git clone https://github.com/no87xis/Sirius_sklad_new.git
cd Sirius_sklad_new
echo "‚úÖ –ö–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω"

# 6. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üìã 6. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
python3 -m venv venv
source venv/bin/activate
echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"

# 7. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üìã 7. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install --upgrade pip
pip install -r requirements.txt
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# 8. –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
echo "üìã 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
cat > .env << EOF
DATABASE_URL=sqlite:///./sirius_sklad.db
SECRET_KEY=your-secret-key-here-change-in-production
DEBUG=True
EOF

# 9. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìã 9. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p static/uploads/products
mkdir -p static/uploads/qr
chmod -R 755 static/uploads

# 10. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –±—ã–ª–∞)
echo "üìã 10. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "../sirius_sklad_backup_$(date +%Y%m%d)*.db" ]; then
    echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
    cp ../sirius_sklad_backup_*.db sirius_sklad.db
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
fi

# 11. –ò–î–ï–ê–õ–¨–ù–ê–Ø –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üìã 11. –ò–¥–µ–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
python3 perfect_init.py

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ"
    exit 1
fi

# 12. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –ü–û–õ–ù–´–ú —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
echo "üìã 12. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –ü–û–õ–ù–´–ú —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º..."
echo "üöÄ –í–∫–ª—é—á–∞–µ–º –í–°–ï —Ñ—É–Ω–∫—Ü–∏–∏: —Å–∫–ª–∞–¥, –º–∞–≥–∞–∑–∏–Ω, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, QR-–∫–æ–¥—ã"
nohup python3 -m uvicorn app.main_perfect_full:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &

# 13. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìã 13. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
sleep 5

if pgrep -f "uvicorn" > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo "üåê –°–∞–π—Ç: http://185.239.50.157:8000"
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è: http://185.239.50.157:8000/health"
    echo "üìä –°–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π: http://185.239.50.157:8000/features"
    echo "üë§ –ê–¥–º–∏–Ω: admin / admin123"
    echo "üìã –õ–æ–≥: tail -f server.log"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥:"
    tail -20 server.log
    exit 1
fi

# 14. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "üìã 14. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
sleep 3
if curl -s http://localhost:8000/health > /dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã!"
    echo "üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    if curl -s http://localhost:8000/features > /dev/null; then
        echo "‚úÖ –§—É–Ω–∫—Ü–∏—è /features —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
    if curl -s http://localhost:8000/shop > /dev/null; then
        echo "‚úÖ –ú–∞–≥–∞–∑–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
    if curl -s http://localhost:8000/products > /dev/null; then
        echo "‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
    if curl -s http://localhost:8000/orders > /dev/null; then
        echo "‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
    if curl -s http://localhost:8000/analytics > /dev/null; then
        echo "‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
    if curl -s http://localhost:8000/admin > /dev/null; then
        echo "‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
else
    echo "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω, –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥: tail -f server.log"
fi

echo "======================================================"
echo "üéâ –ò–î–ï–ê–õ–¨–ù–ê–Ø –ü–û–õ–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "üöÄ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –í–°–ï–ú–ò —Ñ—É–Ω–∫—Ü–∏—è–º–∏ Sirius Group"
echo "‚úÖ –°–∫–ª–∞–¥ –∏ –æ—Å—Ç–∞—Ç–∫–∏"
echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω —Å –∫–æ—Ä–∑–∏–Ω–æ–π"
echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø–æ—Å—Ç–∞–≤–æ–∫"
echo "‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤"
echo "‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å"
echo "‚úÖ QR-–∫–æ–¥—ã –∏ —Å–∫–∞–Ω–µ—Ä"
echo "‚úÖ –û—Ç—á–µ—Ç—ã –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
echo "‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
echo "======================================================"
