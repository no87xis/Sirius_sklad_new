# План миграции на PostgreSQL

## Обзор

Данный документ описывает план перехода с SQLite на PostgreSQL для production окружения.

## Преимущества PostgreSQL

- **Производительность**: Лучшая производительность при больших объемах данных
- **Масштабируемость**: Поддержка параллельных запросов и индексов
- **Надежность**: ACID-совместимость и поддержка транзакций
- **Расширяемость**: Поддержка JSON, полнотекстового поиска, геоданных
- **Безопасность**: Роли, права доступа, шифрование

## Этапы миграции

### Этап 1: Подготовка (1-2 недели)

1. **Анализ текущей схемы**
   - Аудит всех таблиц и связей
   - Выявление SQLite-специфичных конструкций
   - Планирование оптимизации схемы

2. **Подготовка инфраструктуры**
   - Установка PostgreSQL на сервере
   - Настройка пользователей и прав доступа
   - Создание резервных копий

3. **Адаптация кода**
   - Обновление SQLAlchemy для PostgreSQL
   - Замена SQLite-специфичных запросов
   - Обновление миграций Alembic

### Этап 2: Тестирование (2-3 недели)

1. **Создание тестовой среды**
   - Развертывание PostgreSQL в тестовой среде
   - Миграция тестовых данных
   - Проведение нагрузочного тестирования

2. **Валидация функциональности**
   - Тестирование всех API endpoints
   - Проверка производительности
   - Тестирование отката

### Этап 3: Миграция (1 неделя)

1. **Подготовка к миграции**
   - Создание финальной резервной копии
   - Планирование downtime
   - Уведомление пользователей

2. **Выполнение миграции**
   - Остановка приложения
   - Экспорт данных из SQLite
   - Импорт в PostgreSQL
   - Обновление конфигурации
   - Запуск приложения

3. **Валидация после миграции**
   - Проверка целостности данных
   - Мониторинг производительности
   - Тестирование критических функций

## Технические детали

### Изменения в конфигурации

```python
# config.py
class Settings(BaseSettings):
    # Заменить на:
    database_url: str = "postgresql://user:password@localhost/sirius"
    
    # Добавить настройки PostgreSQL:
    postgres_pool_size: int = 20
    postgres_max_overflow: int = 30
    postgres_pool_timeout: int = 30
```

### Обновление requirements.txt

```txt
# Добавить:
psycopg2-binary==2.9.7  # PostgreSQL драйвер
```

### Изменения в моделях

1. **Типы данных**
   - `String` → `VARCHAR` с указанием длины
   - `Text` → `TEXT` (без изменений)
   - `Numeric` → `DECIMAL` с точностью

2. **Индексы**
   - Добавить составные индексы для сложных запросов
   - Использовать частичные индексы где возможно

3. **Ограничения**
   - Добавить CHECK constraints для валидации
   - Использовать UNIQUE constraints эффективно

### Оптимизация запросов

1. **Анализ планов выполнения**
   ```sql
   EXPLAIN ANALYZE SELECT * FROM orders WHERE status = 'pending';
   ```

2. **Создание индексов**
   ```sql
   CREATE INDEX CONCURRENTLY idx_orders_status_created 
   ON orders(status, created_at);
   ```

3. **Партиционирование**
   ```sql
   -- Для больших таблиц по дате
   CREATE TABLE orders_2024 PARTITION OF orders
   FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
   ```

## Риски и митигация

### Риски

1. **Потеря данных**
   - Митигация: Множественные резервные копии, тестирование миграции

2. **Downtime**
   - Митигация: Минимизация времени миграции, планирование в нерабочее время

3. **Проблемы производительности**
   - Митигация: Нагрузочное тестирование, мониторинг

### План отката

1. **Критерии отката**
   - Критические ошибки в данных
   - Значительное снижение производительности
   - Проблемы с безопасностью

2. **Процедура отката**
   - Остановка приложения
   - Восстановление из резервной копии SQLite
   - Возврат к предыдущей версии кода

## Мониторинг после миграции

### Ключевые метрики

1. **Производительность**
   - Время отклика API
   - Время выполнения запросов к БД
   - Использование ресурсов

2. **Надежность**
   - Количество ошибок
   - Время доступности
   - Размер логов

3. **Бизнес-метрики**
   - Количество заказов в час
   - Время обработки заказов
   - Удовлетворенность пользователей

### Инструменты мониторинга

- **pg_stat_statements** - статистика запросов
- **pg_stat_bgwriter** - статистика записи
- **pg_stat_database** - статистика БД
- **Prometheus + Grafana** - визуализация метрик

## Временные рамки

- **Общая продолжительность**: 6-8 недель
- **Критический путь**: 4 недели
- **Буфер безопасности**: 2-4 недели

## Заключение

Миграция на PostgreSQL значительно улучшит производительность, надежность и масштабируемость системы. Тщательное планирование и тестирование минимизируют риски и обеспечат успешную миграцию.
