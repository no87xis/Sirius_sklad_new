@echo off & chcp 65001 >nul
REM Sirius Group - Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
REM ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸, Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
if "%1"=="up" goto :start_server
if "%1"=="down" goto :stop_server
if "%1"=="status" goto :check_status
if "%1"=="logs" goto :show_logs

REM Ð•ÑÐ»Ð¸ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð½ÐµÑ‚, Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¾Ð±Ñ‹Ñ‡Ð½ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ
goto :build_project

:start_server
echo.
echo ========================================
echo   Sirius Group - Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
echo ========================================
echo.
call scripts\win\serve_dev.cmd
goto :end

:stop_server
echo.
echo ========================================
echo   Sirius Group - ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
echo ========================================
echo.
call scripts\win\serve_stop.cmd
goto :end

:check_status
echo.
echo ========================================
echo   Sirius Group - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°
echo ========================================
echo.
call scripts\win\serve_status.cmd
goto :end

:show_logs
echo.
echo ========================================
echo   Sirius Group - Ð›Ð¾Ð³Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°
echo ========================================
echo.
if exist "logs\uvicorn-dev.log" (
    echo ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 20 ÑÑ‚Ñ€Ð¾Ðº Ð»Ð¾Ð³Ð¾Ð²:
    echo.
    powershell -Command "Get-Content 'logs\uvicorn-dev.log' -Tail 20 -ErrorAction SilentlyContinue"
) else (
    echo Ð¤Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¾Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: logs\uvicorn-dev.log
)
echo.
echo Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ:
echo   powershell Get-Content logs\uvicorn-dev.log -Wait -Tail 10
goto :end

:build_project
echo.
echo ========================================
echo   Sirius Group - Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo ========================================
echo.

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if not exist "app\main.py" (
    echo ÐžÐ¨Ð˜Ð‘ÐšÐ: app\main.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
    pause
    exit /b 1
)

echo ðŸ”§ ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ ÐŸÐ ÐžÐ•ÐšÐ¢Ð...
echo.

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python
echo 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python...
python --version
if %errorlevel% neq 0 (
    echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: Python Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Python 3.8+
    pause
    exit /b 1
)
echo âœ… Python Ð½Ð°Ð¹Ð´ÐµÐ½
echo.

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼/ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ...
if not exist "venv\Scripts\activate.bat" (
    echo ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ...
    python -m venv venv
    if %errorlevel% neq 0 (
        echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
        pause
        exit /b 1
    )
    echo âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾
) else (
    echo âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
)
echo.

REM ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo 3. ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ...
call venv\Scripts\activate.bat
if %errorlevel% neq 0 (
    echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
    pause
    exit /b 1
)
echo âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾
echo.

REM ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip
echo 4. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip...
python -m pip install --upgrade pip
if %errorlevel% neq 0 (
    echo âš ï¸  ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ pip
)
echo.

REM Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo 5. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸...
if exist "requirements.txt" (
    pip install -r requirements.txt
    if %errorlevel% neq 0 (
        echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        pause
        exit /b 1
    )
    echo âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹
) else (
    echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: requirements.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½
    pause
    exit /b 1
)
echo.

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸
echo 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸...
python -c "import fastapi, uvicorn, sqlalchemy, alembic" 2>nul
if %errorlevel% neq 0 (
    echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ Ð²ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
    echo ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ: pip install -r requirements.txt
    pause
    exit /b 1
)
echo âœ… ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹
echo.

REM Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ logs
echo 7. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ logs...
if not exist "logs" mkdir logs
echo âœ… ÐŸÐ°Ð¿ÐºÐ° logs Ð³Ð¾Ñ‚Ð¾Ð²Ð°
echo.

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo 8. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…...
if exist "sirius.db" (
    echo âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: sirius.db
) else (
    echo âš ï¸  Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. Ð‘ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ.
)
echo.

REM ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
echo 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸...
if exist "alembic.ini" (
    echo ðŸ“‹ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Alembic...
    alembic current
    if %errorlevel% equ 0 (
        alembic upgrade head
        if %errorlevel% neq 0 (
            echo âš ï¸  ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
        ) else (
            echo âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹
        )
    ) else (
        echo âš ï¸  ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•: Alembic Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½
    )
) else (
    echo â„¹ï¸  ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Alembic Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹
)
echo.

REM ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
echo 10. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ...
if exist ".env" (
    echo âœ… Ð¤Ð°Ð¹Ð» .env Ð½Ð°Ð¹Ð´ÐµÐ½
) else (
    if exist "env.example" (
        echo ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ð¸Ð· env.example...
        copy env.example .env
        echo âœ… Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸.
    ) else (
        echo âš ï¸  ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•: Ð¤Ð°Ð¹Ð»Ñ‹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹
    )
)
echo.

REM Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
echo 11. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°...
python -c "from app.main import app; print('âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ÑÑ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾')" 2>nul
if %errorlevel% neq 0 (
    echo âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
    echo ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð´ Ð² app/main.py
    pause
    exit /b 1
)
echo.

echo ðŸŽ‰ Ð¡Ð‘ÐžÐ ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž!
echo.
echo ðŸ“‹ Ð¡Ð›Ð•Ð”Ð£Ð®Ð©Ð˜Ð• Ð¨ÐÐ“Ð˜:
echo.
echo   1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ dev-ÑÐµÑ€Ð²ÐµÑ€:
echo      scripts\win\serve_dev.cmd
echo.
echo   2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€:
echo      http://127.0.0.1:8000
echo.
echo   3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ:
echo      scripts\win\serve_status.cmd
echo.
echo   4. ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€:
echo      scripts\win\serve_stop.cmd
echo.

echo ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð»ÑŽÐ±ÑƒÑŽ ÐºÐ»Ð°Ð²Ð¸ÑˆÑƒ Ð´Ð»Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð°...
pause >nul
