{% extends "admin/base.html" %}

{% block title %}–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">üì¶ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ</h1>
        <p class="mt-2 text-sm sm:text-base text-gray-600">
            –¢–æ–≤–∞—Ä—ã —Å –ø—Ä–∏–±–ª–∏–∂–∞—é—â–µ–π—Å—è –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –¥–∞—Ç–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
        </p>
    </div>

    <!-- –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    {% if overdue_deliveries %}
    <div class="mb-8">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-semibold text-red-800 mb-2">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ ({{ overdue_deliveries|length }})
            </h2>
            <p class="text-red-700 text-sm">–¢–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –ø—Ä–∏–±—ã—Ç—å, –Ω–æ –Ω–µ –ø—Ä–∏–±—ã–ª–∏</p>
        </div>

        <div class="grid gap-4">
            {% for delivery in overdue_deliveries %}
            <div class="bg-white border border-red-200 rounded-lg p-4 shadow-sm">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">{{ delivery.product_name }}</h3>
                        <div class="mt-1 text-sm text-gray-600">
                            <span class="font-medium">–ü–∞—Ä—Ç–∏—è:</span> {{ delivery.batch_code }} | 
                            <span class="font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span> {{ delivery.quantity }} —à—Ç. |
                            <span class="font-medium">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞:</span> 
                            <span class="text-red-600 font-semibold">{{ delivery.days_overdue }} –¥–Ω.</span>
                        </div>
                        <div class="mt-1 text-sm text-gray-500">
                            <span class="font-medium">–û–∂–∏–¥–∞–ª–æ—Å—å:</span> {{ delivery.expected_arrival_date.strftime('%d.%m.%Y') }}
                        </div>
                        {% if delivery.preorder_price %}
                        <div class="mt-1 text-sm text-gray-500">
                            <span class="font-medium">–¶–µ–Ω–∞ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞:</span> {{ "%.2f"|format(delivery.preorder_price) }} ‚ÇΩ
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-3 sm:mt-0 sm:ml-4 flex flex-col sm:flex-row gap-2">
                        <button onclick="showUpdateDateModal({{ delivery.batch_id }}, '{{ delivery.expected_arrival_date.strftime('%Y-%m-%d') }}')"
                                class="px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É
                        </button>
                        <button onclick="showMarkArrivedModal({{ delivery.batch_id }}, '{{ delivery.product_name }}')"
                                class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-check mr-1"></i>
                            –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–±—ã–≤—à–∏–º
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ü—Ä–∏–±–ª–∏–∂–∞—é—â–∏–µ—Å—è –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    {% if upcoming_deliveries %}
    <div class="mb-8">
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-semibold text-yellow-800 mb-2">
                <i class="fas fa-clock mr-2"></i>
                –ü—Ä–∏–±–ª–∏–∂–∞—é—â–∏–µ—Å—è –¥–æ—Å—Ç–∞–≤–∫–∏ ({{ upcoming_deliveries|length }})
            </h2>
            <p class="text-yellow-700 text-sm">–¢–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–±—ã—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 5 –¥–Ω–µ–π</p>
        </div>

        <div class="grid gap-4">
            {% for delivery in upcoming_deliveries %}
            <div class="bg-white border {% if delivery.is_urgent %}border-red-200{% else %}border-yellow-200{% endif %} rounded-lg p-4 shadow-sm">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">{{ delivery.product_name }}</h3>
                        <div class="mt-1 text-sm text-gray-600">
                            <span class="font-medium">–ü–∞—Ä—Ç–∏—è:</span> {{ delivery.batch_code }} | 
                            <span class="font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span> {{ delivery.quantity }} —à—Ç. |
                            <span class="font-medium">–î–æ –¥–æ—Å—Ç–∞–≤–∫–∏:</span> 
                            <span class="{% if delivery.is_urgent %}text-red-600 font-semibold{% else %}text-yellow-600 font-semibold{% endif %}">
                                {{ delivery.days_until_delivery }} –¥–Ω.
                            </span>
                        </div>
                        <div class="mt-1 text-sm text-gray-500">
                            <span class="font-medium">–û–∂–∏–¥–∞–µ—Ç—Å—è:</span> {{ delivery.expected_arrival_date.strftime('%d.%m.%Y') }}
                        </div>
                        {% if delivery.preorder_price %}
                        <div class="mt-1 text-sm text-gray-500">
                            <span class="font-medium">–¶–µ–Ω–∞ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞:</span> {{ "%.2f"|format(delivery.preorder_price) }} ‚ÇΩ
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-3 sm:mt-0 sm:ml-4 flex flex-col sm:flex-row gap-2">
                        <button onclick="showUpdateDateModal({{ delivery.batch_id }}, '{{ delivery.expected_arrival_date.strftime('%Y-%m-%d') }}')"
                                class="px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É
                        </button>
                        <button onclick="showMarkArrivedModal({{ delivery.batch_id }}, '{{ delivery.product_name }}')"
                                class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-check mr-1"></i>
                            –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–±—ã–≤—à–∏–º
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    {% if not upcoming_deliveries and not overdue_deliveries %}
    <div class="text-center py-12">
        <div class="mx-auto h-12 w-12 text-gray-400 mb-4">
            <i class="fas fa-check-circle text-4xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">–í—Å–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ</h3>
        <p class="text-gray-500">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏–±–ª–∏–∂–∞—é—â–µ–π—Å—è –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –¥–∞—Ç–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏</p>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã -->
<div id="updateDateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
            <form id="updateDateForm" method="POST" action="/admin/delivery-notifications/update-date" class="space-y-4">
                <input type="hidden" name="batch_id" id="update_batch_id">
                <div>
                    <label for="new_date" class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                    <input type="date" name="new_date" id="new_date" required 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button type="button" onclick="hideUpdateDateModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–∏–±—ã–≤—à–∏–º -->
<div id="markArrivedModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–±—ã–≤—à–∏–π</h3>
            <p class="text-sm text-gray-600 mb-4" id="markArrivedProductName"></p>
            <form id="markArrivedForm" method="POST" action="/admin/delivery-notifications/mark-arrived" class="space-y-4">
                <input type="hidden" name="batch_id" id="mark_batch_id">
                <div>
                    <label for="final_price" class="block text-sm font-medium text-gray-700 mb-2">–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="number" name="final_price" id="final_price" step="0.01" min="0"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–±—ã–≤—à–∏–º
                    </button>
                    <button type="button" onclick="hideMarkArrivedModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showUpdateDateModal(batchId, currentDate) {
    document.getElementById('update_batch_id').value = batchId;
    document.getElementById('new_date').value = currentDate;
    document.getElementById('updateDateModal').classList.remove('hidden');
}

function hideUpdateDateModal() {
    document.getElementById('updateDateModal').classList.add('hidden');
}

function showMarkArrivedModal(batchId, productName) {
    document.getElementById('mark_batch_id').value = batchId;
    document.getElementById('markArrivedProductName').textContent = `–¢–æ–≤–∞—Ä: ${productName}`;
    document.getElementById('markArrivedModal').classList.remove('hidden');
}

function hideMarkArrivedModal() {
    document.getElementById('markArrivedModal').classList.add('hidden');
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
window.onclick = function(event) {
    const updateModal = document.getElementById('updateDateModal');
    const markModal = document.getElementById('markArrivedModal');
    
    if (event.target === updateModal) {
        hideUpdateDateModal();
    }
    if (event.target === markModal) {
        hideMarkArrivedModal();
    }
}
</script>
{% endblock %}





