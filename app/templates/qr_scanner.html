{% extends "base.html" %}

{% block title %}QR-—Å–∫–∞–Ω–µ—Ä –∑–∞–∫–∞–∑–æ–≤ - –°–∏—Ä–∏—É—Å{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4 sm:py-8">
    <div class="max-w-4xl mx-auto">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 space-y-4 sm:space-y-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">QR-—Å–∫–∞–Ω–µ—Ä –∑–∞–∫–∞–∑–æ–≤</h1>
            <a href="javascript:history.back()" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm text-center">
                ‚Üê –ù–∞–∑–∞–¥
            </a>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-base sm:text-lg font-semibold text-blue-900 mb-2">üì± –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫–∞–Ω–µ—Ä:</h3>
            <ul class="text-blue-800 space-y-1 text-sm sm:text-base">
                <li>‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±—Ä–∞—É–∑–µ—Ä–∞</li>
                <li>‚Ä¢ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞</li>
                <li>‚Ä¢ –°–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–¥ –∏ –ø–µ—Ä–µ–π–¥–µ—Ç –∫ –∑–∞–∫–∞–∑—É</li>
                <li>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å –∫–∞–º–µ—Ä—É" –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è</li>
            </ul>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–∞–Ω–µ—Ä -->
        <div class="bg-white rounded-lg shadow p-4 sm:p-6">
            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="mb-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <button id="startCamera" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-colors">
                    üì∑ –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                </button>
                <button id="selectCamera" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-colors" style="display: none;">
                    üîÑ –í—ã–±—Ä–∞—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="stopCamera" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-base transition-colors" style="display: none;">
                    üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
            </div>
            
            <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –∫–∞–º–µ—Ä—ã -->
            <div id="cameraSelector" class="mb-4" style="display: none;">
                <label for="cameraSelect" class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É:</label>
                <select id="cameraSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>
                </select>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–º–µ—Ä—ã -->
            <div id="cameraContainer" class="w-full max-w-md mx-auto mb-4 border-2 border-dashed border-gray-300 rounded-lg overflow-hidden" style="display: none;">
                <video id="cameraVideo" 
                       playsinline 
                       autoplay 
                       muted 
                       class="w-full h-64 object-cover"
                       style="display: none;">
                </video>
                <canvas id="cameraCanvas" class="w-full h-64" style="display: none;"></canvas>
                
                <!-- –ù–∞–ø—Ä–∞–≤–ª—è—é—â–∞—è —Ä–∞–º–∫–∞ -->
                <div id="scannerOverlay" class="absolute inset-0 pointer-events-none" style="display: none;">
                    <div class="relative w-full h-full">
                        <!-- –†–∞–º–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 border-2 border-blue-500 rounded-lg">
                            <!-- –£–≥–ª—ã —Ä–∞–º–∫–∏ -->
                            <div class="absolute -top-1 -left-1 w-4 h-4 border-t-2 border-l-2 border-blue-500 rounded-tl-lg"></div>
                            <div class="absolute -top-1 -right-1 w-4 h-4 border-t-2 border-r-2 border-blue-500 rounded-tr-lg"></div>
                            <div class="absolute -bottom-1 -left-1 w-4 h-4 border-b-2 border-l-2 border-blue-500 rounded-bl-lg"></div>
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 border-b-2 border-r-2 border-blue-500 rounded-br-lg"></div>
                        </div>
                        
                        <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div id="scanLine" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-0.5 bg-blue-500 animate-pulse"></div>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –∫–∞–º–µ—Ä—ã -->
                <div id="cameraStatus" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="text-center text-white">
                        <div class="text-4xl mb-2">üì∑</div>
                        <div class="text-sm">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...</div>
                    </div>
                </div>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div id="scanStatus" class="text-center text-gray-500 text-sm sm:text-base">
                –ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.
            </div>
            
            <!-- –û—à–∏–±–∫–∏ -->
            <div id="cameraError" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg" style="display: none;">
                <div class="flex items-center">
                    <div class="text-red-600 text-xl mr-2">‚ö†Ô∏è</div>
                    <div class="flex-1">
                        <div class="font-semibold text-red-800">–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã</div>
                        <div id="errorMessage" class="text-red-700 text-sm"></div>
                        <div class="mt-2 space-y-2">
                            <button id="retryCamera" class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded">
                                üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                            <button id="uploadQR" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded ml-2">
                                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ QR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ QR-–∫–æ–¥–∞ -->
        <div id="uploadSection" class="bg-white rounded-lg shadow p-4 sm:p-6 mt-6" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ QR-–∫–æ–¥–∞</h3>
            <div class="space-y-4">
                <div>
                    <label for="qrFileInput" class="block text-sm font-medium text-gray-700 mb-2">
                        –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å QR-–∫–æ–¥–æ–º:
                    </label>
                    <input type="file" 
                           id="qrFileInput" 
                           accept="image/*" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
                           onchange="handleFileUpload(this)">
                </div>
                <div class="text-sm text-gray-600">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP
                </div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div id="scanResult" class="bg-white rounded-lg shadow p-4 sm:p-6 mt-6" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="resultContent"></div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
<input type="file" id="hiddenFileInput" accept="image/*" style="display: none;">

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º jsQR –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let mediaStream = null;
let videoTrack = null;
let animationFrame = null;
let isScanning = false;
let availableCameras = [];
let currentCameraId = null;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const startBtn = document.getElementById('startCamera');
const selectBtn = document.getElementById('selectCamera');
const stopBtn = document.getElementById('stopCamera');
const cameraSelector = document.getElementById('cameraSelector');
const cameraSelect = document.getElementById('cameraSelect');
const cameraContainer = document.getElementById('cameraContainer');
const cameraVideo = document.getElementById('cameraVideo');
const cameraCanvas = document.getElementById('cameraCanvas');
const scannerOverlay = document.getElementById('scannerOverlay');
const cameraStatus = document.getElementById('cameraStatus');
const scanStatus = document.getElementById('scanStatus');
const cameraError = document.getElementById('cameraError');
const errorMessage = document.getElementById('errorMessage');
const retryBtn = document.getElementById('retryBtn');
const uploadBtn = document.getElementById('uploadQR');
const uploadSection = document.getElementById('uploadSection');
const scanResult = document.getElementById('scanResult');
const resultContent = document.getElementById('resultContent');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
startBtn.addEventListener('click', startCamera);
selectBtn.addEventListener('click', showCameraSelector);
stopBtn.addEventListener('click', stopCamera);
retryBtn.addEventListener('click', startCamera);
uploadBtn.addEventListener('click', () => document.getElementById('qrFileInput').click());

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–º–µ—Ä
    getAvailableCameras();
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–º–µ—Ä
async function getAvailableCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(device => device.kind === 'videoinput');
        
        if (availableCameras.length === 0) {
            showError('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –≤–∏–¥–µ–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
            return;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–∞–º–µ—Ä
        cameraSelect.innerHTML = availableCameras.map((camera, index) => {
            const label = camera.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
            return `<option value="${camera.deviceId}">${label}</option>`;
        }).join('');
        
        // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (availableCameras.length > 0) {
            currentCameraId = availableCameras[0].deviceId;
            cameraSelect.value = currentCameraId;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –µ—Å–ª–∏ –∫–∞–º–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–æ
        if (availableCameras.length > 1) {
            selectBtn.style.display = 'inline-block';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä');
    }
}

// –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
async function startCamera() {
    try {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
        hideError();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–º–µ—Ä—ã
        cameraContainer.style.display = 'block';
        cameraStatus.style.display = 'flex';
        scannerOverlay.style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        scanStatus.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...';
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        const constraints = {
            video: {
                facingMode: 'environment', // –¢—ã–ª–æ–≤–∞—è –∫–∞–º–µ—Ä–∞
                width: { ideal: 1280, max: 1920 },
                height: { ideal: 720, max: 1080 }
            },
            audio: false
        };
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–∞–º–µ—Ä–∞
        if (currentCameraId) {
            constraints.video.deviceId = { exact: currentCameraId };
        }
        
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoTrack = mediaStream.getVideoTracks()[0];
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ
        cameraVideo.srcObject = mediaStream;
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
        await new Promise((resolve) => {
            cameraVideo.onloadedmetadata = resolve;
        });
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ
        await cameraVideo.play();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
        cameraStatus.style.display = 'none';
        cameraVideo.style.display = 'block';
        scannerOverlay.style.display = 'block';
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        startScanning();
        
        scanStatus.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ... –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
        handleCameraError(error);
    }
}

// –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function startScanning() {
    if (isScanning) return;
    
    isScanning = true;
    scanFrame();
}

// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–∞
function scanFrame() {
    if (!isScanning || !mediaStream) return;
    
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ
        const videoWidth = cameraVideo.videoWidth;
        const videoHeight = cameraVideo.videoHeight;
        
        if (videoWidth === 0 || videoHeight === 0) {
            // –í–∏–¥–µ–æ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            animationFrame = requestAnimationFrame(scanFrame);
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–∞
        const canvas = cameraCanvas;
        const ctx = canvas.getContext('2d');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
        canvas.width = videoWidth;
        canvas.height = videoHeight;
        
        // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤–∏–¥–µ–æ –Ω–∞ canvas
        ctx.drawImage(cameraVideo, 0, 0, videoWidth, videoHeight);
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const imageData = ctx.getImageData(0, 0, videoWidth, videoHeight);
        
        // –†–∞—Å–ø–æ–∑–Ω–∞–µ–º QR-–∫–æ–¥
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            // QR-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω!
            console.log('QR-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω:', code.data);
            onScanSuccess(code.data);
            return;
        }
        
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        animationFrame = requestAnimationFrame(scanFrame);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        animationFrame = requestAnimationFrame(scanFrame);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function onScanSuccess(qrCode) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    stopScanning();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    showScanResult(qrCode);
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É—Å–ø–µ—Ö–∞
    playSuccessSound();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–∫–∞–∑—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        redirectToOrder(qrCode);
    }, 2000);
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function showScanResult(qrCode) {
    resultContent.innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center mb-3">
                <div class="text-green-600 text-2xl mr-2">‚úÖ</div>
                <h4 class="text-lg font-semibold text-green-900">QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!</h4>
            </div>
            <div class="space-y-2">
                <div><strong>–ö–æ–¥ –∑–∞–∫–∞–∑–∞:</strong> <span class="font-mono text-lg">${qrCode}</span></div>
                <div><strong>–í—Ä–µ–º—è:</strong> ${new Date().toLocaleString('ru-RU')}</div>
            </div>
            <div class="mt-4 p-3 bg-blue-50 rounded border">
                <p class="text-sm text-blue-700">
                    <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–∫–∞–∑—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...</strong><br>
                    –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
                </p>
            </div>
            <div class="mt-4 space-x-2">
                <button onclick="redirectToOrder('${qrCode}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm">
                    üîç –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑—É
                </button>
                <button onclick="copyToClipboard('${qrCode}')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm">
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                </button>
            </div>
        </div>
    `;
    
    scanResult.style.display = 'block';
}

// –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–∫–∞–∑—É
function redirectToOrder(qrCode) {
    // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    scanResult.style.display = 'none';
    
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–∫–∞–∑–∞
    window.location.href = `/orders/search?code=${encodeURIComponent(qrCode)}`;
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function stopScanning() {
    isScanning = false;
    if (animationFrame) {
        cancelAnimationFrame(animationFrame);
        animationFrame = null;
    }
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
function stopCamera() {
    stopScanning();
    
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
        videoTrack = null;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
    cameraVideo.style.display = 'none';
    scannerOverlay.style.display = 'none';
    cameraStatus.style.display = 'flex';
    cameraStatus.innerHTML = `
        <div class="text-center text-white">
            <div class="text-4xl mb-2">üì∑</div>
            <div class="text-sm">–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>
        </div>
    `;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    scanStatus.textContent = '–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.';
}

// –ü–æ–∫–∞–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–∞–º–µ—Ä
function showCameraSelector() {
    cameraSelector.style.display = 'block';
    cameraSelect.focus();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞–º–µ—Ä—ã
cameraSelect.addEventListener('change', function() {
    currentCameraId = this.value;
    if (mediaStream) {
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π
        stopCamera();
        setTimeout(startCamera, 100);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–∞–º–µ—Ä—ã
function handleCameraError(error) {
    console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
    
    let errorText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    
    if (error.name === 'NotAllowedError') {
        errorText = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
    } else if (error.name === 'NotFoundError') {
        errorText = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã.';
    } else if (error.name === 'NotReadableError') {
        errorText = '–ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
    } else if (error.name === 'OverconstrainedError') {
        errorText = '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.';
    } else if (error.name === 'SecurityError') {
        errorText = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.';
    } else if (error.name === 'AbortError') {
        errorText = '–û–ø–µ—Ä–∞—Ü–∏—è —Å –∫–∞–º–µ—Ä–æ–π –±—ã–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞.';
    }
    
    showError(errorText);
    stopCamera();
}

// –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
function showError(message) {
    errorMessage.textContent = message;
    cameraError.style.display = 'block';
    uploadSection.style.display = 'block';
}

// –°–∫—Ä—ã—Ç–∏–µ –æ—à–∏–±–∫–∏
function hideError() {
    cameraError.style.display = 'none';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            
            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ canvas
            ctx.drawImage(img, 0, 0);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageData = ctx.getImageData(0, 0, img.width, img.height);
            
            // –†–∞—Å–ø–æ–∑–Ω–∞–µ–º QR-–∫–æ–¥
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                onScanSuccess(code.data);
            } else {
                showError('QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
            }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
    }).catch(() => {
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥', 'error');
    });
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg text-white font-medium z-50 text-sm ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —É—Å–ø–µ—Ö–∞
function playSuccessSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (error) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', error);
    }
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}
