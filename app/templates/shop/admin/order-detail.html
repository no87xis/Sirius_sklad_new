{% extends "shop/base.html" %}
{% from datetime import timedelta %}

{% block title %}–ó–∞–∫–∞–∑ {{ order.order_code }} - –ê–¥–º–∏–Ω–∫–∞{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">–ó–∞–∫–∞–∑ {{ order.order_code }}</h1>
            <p class="text-lg text-gray-600">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ (–∞–¥–º–∏–Ω–∫–∞)</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h2>
                    
                    <div class="space-y-3">
                        <div>
                            <span class="text-sm font-medium text-gray-500">–ö–æ–¥ –∑–∞–∫–∞–∑–∞:</span>
                            <span class="ml-2 font-mono text-lg text-blue-600">{{ order.order_code }}</span>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å:</span>
                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if order.status == 'completed' %}bg-green-100 text-green-800
                                {% elif order.status == 'paid' %}bg-blue-100 text-blue-800
                                {% elif order.status == 'ordered_not_paid' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if order.status == 'ordered_not_paid' %}
                                    –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
                                {% elif order.status == 'paid' %}
                                    –û–ø–ª–∞—á–µ–Ω
                                {% elif order.status == 'completed' %}
                                    –í—ã–¥–∞–Ω
                                {% else %}
                                    {{ order.status }}
                                {% endif %}
                            </span>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
                            <span class="ml-2">{{ order.created_at.strftime('%d.%m.%Y %H:%M') if order.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span>
                        </div>
                        
                        {% if order.paid_at %}
                        <div>
                            <span class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</span>
                            <span class="ml-2">{{ order.paid_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                        
                        {% if order.completed_at %}
                        <div>
                            <span class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</span>
                            <span class="ml-2">{{ order.completed_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h2>
                    
                    <div class="space-y-3">
                        <div>
                            <span class="text-sm font-medium text-gray-500">–ò–º—è:</span>
                            <span class="ml-2">{{ order.customer_name }}</span>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                            <span class="ml-2">{{ order.customer_phone }}</span>
                        </div>
                        
                        <div>
                            <span class="text-sm font-medium text-gray-500">–ì–æ—Ä–æ–¥:</span>
                            <span class="ml-2">
                                {% if order.customer_city and order.customer_city != 'custom' %}
                                    {{ order.customer_city }}
                                {% else %}
                                    –ù–µ —É–∫–∞–∑–∞–Ω
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">–¢–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑–µ</h2>
            
            <div class="border rounded-lg p-4">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">{{ order.product_name }}</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                                <span class="ml-2 font-medium">{{ order.quantity }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                                <span class="ml-2 font-medium">{{ order.unit_price_rub }} ‚ÇΩ</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-blue-600">{{ order.total_amount }} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞ -->
        {% if order.has_qr %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞</h2>
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-6">
                <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <img 
                        src="{{ qr_service.get_qr_image_url(order) }}" 
                        alt="QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞ {{ order.order_code }}"
                        class="w-40 h-40"
                    />
                </div>
                
                <div class="flex-1 space-y-3">
                    <p class="text-sm text-gray-600">
                        QR-–∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–∫–∞–∑—É. –ü–æ–∫–∞–∂–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.
                    </p>
                    
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button 
                            onclick="downloadQR('{{ order.order_code }}', '{{ qr_service.get_qr_image_url(order) }}')"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors"
                        >
                            üì• –°–∫–∞—á–∞—Ç—å QR-–∫–æ–¥
                        </button>
                        
                        <button 
                            onclick="copyQRUrl('{{ qr_service.get_qr_public_url(order) }}')"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
                        >
                            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                        </button>
                        
                        <a 
                            href="{{ qr_service.get_qr_public_url(order) }}"
                            target="_blank"
                            class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors text-center"
                        >
                            üîó –û—Ç–∫—Ä—ã—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        </a>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        <p>QR-–∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–∫–∞–∑—É</p>
                        <p>–°—Å—ã–ª–∫–∞: {{ qr_service.get_qr_public_url(order) }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
        {% if order.payment_method_name %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
            <div class="bg-gray-50 rounded-lg p-4">
                <span class="text-lg font-medium text-gray-900">{{ order.payment_method_name }}</span>
            </div>
        </div>
        {% endif %}

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∑–µ—Ä–≤–µ -->
        {% if order.status == 'ordered_not_paid' %}
        <div class="bg-yellow-50 rounded-lg p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-800">
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –¢–æ–≤–∞—Ä—ã —Ä–µ–∑–µ—Ä–≤–∏—Ä—É—é—Ç—Å—è –Ω–∞ 48 —á–∞—Å–æ–≤. –í —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ–ø–ª–∞—Ç—ã —Ä–µ–∑–µ—Ä–≤ —Å–Ω–∏–º–∞–µ—Ç—Å—è.
                    </p>
                    {% if order.created_at %}
                    <p class="text-sm text-yellow-700 mt-1">
                        –†–µ–∑–µ—Ä–≤ –¥–æ: {{ (order.created_at + timedelta(hours=48)).strftime('%d.%m.%Y %H:%M') }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">–î–µ–π—Å—Ç–≤–∏—è</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {% if order.status == 'ordered_not_paid' %}
                <button 
                    onclick="markAsPaid({{ order.id }})"
                    class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
                >
                    üí≥ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
                </button>
                {% endif %}
                
                {% if order.status == 'paid' %}
                <button 
                    onclick="markAsCompleted({{ order.id }})"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                    ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω—ã–π
                </button>
                {% endif %}
                
                {% if order.status in ['ordered_not_paid', 'paid'] %}
                <button 
                    onclick="cancelOrder({{ order.id }})"
                    class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium"
                >
                    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                </button>
                {% endif %}
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
            <a href="/shop/admin/orders" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium text-center">
                üìã –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
            </a>
            
            <a href="/shop/admin/qr-scanner" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium text-center">
                üì± –°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–æ–≤
            </a>
            
            <a href="/shop" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium text-center">
                üõç –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
            </a>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å QR-–∫–æ–¥–∞–º–∏

function downloadQR(orderCode, qrUrl) {
    const link = document.createElement('a');
    link.href = qrUrl;
    link.download = `qr-order-${orderCode}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification('QR-–∫–æ–¥ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...', 'success');
}

function copyQRUrl(qrUrl) {
    const fullUrl = window.location.origin + qrUrl;
    navigator.clipboard.writeText(fullUrl).then(() => {
        showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
    }).catch(() => {
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
    });
}

function showNotification(message, type) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

function markAsPaid(orderId) {
    if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π?')) {
        fetch(`/shop/admin/orders/${orderId}/reserve`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
        });
    }
}

function markAsCompleted(orderId) {
    if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω—ã–π?')) {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω–æ–≥–æ
        showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }
}

function cancelOrder(orderId) {
    if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
        showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }
}
</script>
{% endblock %}
