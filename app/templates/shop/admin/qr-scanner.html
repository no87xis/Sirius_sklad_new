{% extends "shop/base.html" %}

{% block title %}–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–æ–≤{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–æ–≤</h1>
            <p class="text-lg text-gray-600">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>

        <!-- –°–∫–∞–Ω–µ—Ä -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div id="scanner-container" class="mb-4">
                <video id="video" class="w-full rounded-lg" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
            </div>
            
            <div class="text-center space-y-4">
                <button 
                    id="start-scan-btn"
                    onclick="startScanner()"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                    üì± –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
                </button>
                
                <button 
                    id="stop-scan-btn"
                    onclick="stopScanner()"
                    class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium hidden"
                >
                    ‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
                </button>
            </div>
            
            <div id="scan-status" class="mt-4 text-center text-sm text-gray-600">
                –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div id="scan-result" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="result-content"></div>
        </div>

        <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–†—É—á–Ω–æ–π –≤–≤–æ–¥ QR-–∫–æ–¥–∞</h3>
            <form id="manual-qr-form" class="space-y-4">
                <div>
                    <label for="qr_data" class="block text-sm font-medium text-gray-700 mb-1">
                        QR-–¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω
                    </label>
                    <input 
                        type="text" 
                        id="qr_data" 
                        name="qr_data" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ QR-–¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ç–æ–∫–µ–Ω"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <button 
                    type="submit"
                    class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
                >
                    üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å QR-–∫–æ–¥
                </button>
            </form>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <div class="bg-blue-50 rounded-lg p-4 mt-6">
            <h3 class="text-lg font-medium text-blue-800 mb-2">–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫–∞–Ω–µ—Ä</h3>
            <ul class="text-blue-700 space-y-1 text-sm">
                <li>‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä" –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</li>
                <li>‚Ä¢ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞</li>
                <li>‚Ä¢ –°–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–¥ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –∫ –∑–∞–∫–∞–∑—É</li>
                <li>‚Ä¢ –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ QR-–¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –≤ –ø–æ–ª–µ –Ω–∏–∂–µ</li>
            </ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
let stream = null;
let scanning = false;
let animationFrame = null;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('start-scan-btn');
const stopBtn = document.getElementById('stop-scan-btn');
const scanStatus = document.getElementById('scan-status');
const scanResult = document.getElementById('scan-result');
const resultContent = document.getElementById('result-content');
const manualForm = document.getElementById('manual-qr-form');

// –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
async function startScanner() {
    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment', // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        video.srcObject = stream;
        video.play();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');
        scanStatus.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ... –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥';
        
        scanning = true;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        scanFrame();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
        scanStatus.textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
        
        if (error.name === 'NotAllowedError') {
            scanStatus.textContent = '–û—à–∏–±–∫–∞: –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
        } else if (error.name === 'NotFoundError') {
            scanStatus.textContent = '–û—à–∏–±–∫–∞: –∫–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–µ–µ—Ç –∫–∞–º–µ—Ä—É.';
        }
    }
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
function stopScanner() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    if (animationFrame) {
        cancelAnimationFrame(animationFrame);
        animationFrame = null;
    }
    
    scanning = false;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
    video.srcObject = null;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    startBtn.classList.remove('hidden');
    stopBtn.classList.add('hidden');
    scanStatus.textContent = '–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä" –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.';
}

// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–∞
function scanFrame() {
    if (!scanning) return;
    
    try {
        const context = canvas.getContext('2d');
        const width = video.videoWidth;
        const height = video.videoHeight;
        
        if (width && height) {
            canvas.width = width;
            canvas.height = height;
            
            // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –Ω–∞ canvas
            context.drawImage(video, 0, 0, width, height);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageData = context.getImageData(0, 0, width, height);
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º QR-–∫–æ–¥
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                // QR-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω!
                console.log('QR-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω:', code.data);
                handleQRCode(code.data);
                return;
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
    }
    
    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    if (scanning) {
        animationFrame = requestAnimationFrame(scanFrame);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ QR-–∫–æ–¥–∞
async function handleQRCode(qrData) {
    try {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
        stopScanner();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        scanResult.classList.remove('hidden');
        resultContent.innerHTML = `
            <div class="text-center">
                <div class="text-green-600 text-2xl mb-2">‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!</div>
                <p class="text-gray-600 mb-4">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...</p>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            </div>
        `;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const formData = new FormData();
        formData.append('qr_data', qrData);
        
        const response = await fetch('/shop/admin/qr-scan', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –£—Å–ø–µ—à–Ω–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ –∑–∞–∫–∞–∑—É
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="text-green-600 text-2xl mb-2">‚úÖ –ó–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω!</div>
                    <p class="text-gray-600 mb-4">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ –∑–∞–∫–∞–∑—É...</p>
                    <a href="${result.redirect_url}" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑—É
                    </a>
                </div>
            `;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 2000);
            
        } else {
            // –û—à–∏–±–∫–∞
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="text-red-600 text-2xl mb-2">‚ùå –û—à–∏–±–∫–∞</div>
                    <p class="text-gray-600 mb-4">${result.message}</p>
                    <button onclick="resetScanner()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–∞:', error);
        resultContent.innerHTML = `
            <div class="text-center">
                <div class="text-red-600 text-2xl mb-2">‚ùå –û—à–∏–±–∫–∞</div>
                <p class="text-gray-600 mb-4">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å QR-–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
                <button onclick="resetScanner()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
}

// –°–±—Ä–æ—Å —Å–∫–∞–Ω–µ—Ä–∞
function resetScanner() {
    scanResult.classList.add('hidden');
    resultContent.innerHTML = '';
    startScanner();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
manualForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const qrData = document.getElementById('qr_data').value.trim();
    if (!qrData) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    scanResult.classList.remove('hidden');
    resultContent.innerHTML = `
        <div class="text-center">
            <div class="text-blue-600 text-2xl mb-2">üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
            <p class="text-gray-600 mb-4">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...</p>
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
        </div>
    `;
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const formData = new FormData();
        formData.append('qr_data', qrData);
        
        const response = await fetch('/shop/admin/qr-scan', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –£—Å–ø–µ—à–Ω–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ –∑–∞–∫–∞–∑—É
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="text-green-600 text-2xl mb-2">‚úÖ –ó–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω!</div>
                    <p class="text-gray-600 mb-4">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ –∑–∞–∫–∞–∑—É...</p>
                    <a href="${result.redirect_url}" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑—É
                    </a>
                </div>
            `;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 2000);
            
        } else {
            // –û—à–∏–±–∫–∞
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="text-red-600 text-2xl mb-2">‚ùå –û—à–∏–±–∫–∞</div>
                    <p class="text-gray-600 mb-4">${result.message}</p>
                    <button onclick="resetScanner()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–∞:', error);
        resultContent.innerHTML = `
            <div class="text-center">
                <div class="text-red-600 text-2xl mb-2">‚ùå –û—à–∏–±–∫–∞</div>
                <p class="text-gray-600 mb-4">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
                <button onclick="resetScanner()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        `;
    }
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    stopScanner();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(e) {
    console.error('–û—à–∏–±–∫–∞:', e.error);
    scanStatus.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
});
</script>
{% endblock %}
