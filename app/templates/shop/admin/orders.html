{% extends "shop/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –º–∞–≥–∞–∑–∏–Ω–∞{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –º–∞–≥–∞–∑–∏–Ω–∞</h1>
            <p class="text-lg text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="status_filter" class="block text-sm font-medium text-gray-700 mb-1">
                        –°—Ç–∞—Ç—É—Å
                    </label>
                    <select 
                        id="status_filter" 
                        name="status_filter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="ordered_not_paid" {% if status_filter == 'ordered_not_paid' %}selected{% endif %}>
                            –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
                        </option>
                        <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>
                            –û–ø–ª–∞—á–µ–Ω
                        </option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>
                            –í—ã–¥–∞–Ω
                        </option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>
                            –û—Ç–º–µ–Ω–µ–Ω
                        </option>
                    </select>
                </div>
                
                <div>
                    <label for="phone_search" class="block text-sm font-medium text-gray-700 mb-1">
                        –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                    </label>
                    <input 
                        type="text" 
                        id="phone_search" 
                        name="phone_search" 
                        value="{{ phone_search or '' }}"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                
                <div>
                    <label for="code_search" class="block text-sm font-medium text-gray-700 mb-1">
                        –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É
                    </label>
                    <input 
                        type="text" 
                        id="code_search" 
                        name="code_search" 
                        value="{{ code_search or '' }}"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∑–∞–∫–∞–∑–∞"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                
                <div class="flex items-end">
                    <button 
                        type="submit"
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                    >
                        üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </form>
        </div>

        <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
        {% if analytics %}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-bold">{{ analytics.total_orders or 0 }}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</p>
                        <p class="text-lg font-semibold text-gray-900">{{ analytics.total_orders or 0 }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                            <span class="text-yellow-600 font-bold">{{ analytics.pending_orders or 0 }}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</p>
                        <p class="text-lg font-semibold text-gray-900">{{ analytics.pending_orders or 0 }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                            <span class="text-green-600 font-bold">{{ analytics.completed_orders or 0 }}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                        <p class="text-lg font-semibold text-gray-900">{{ analytics.completed_orders or 0 }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            <span class="text-purple-600 font-bold">{{ "%.2f"|format(analytics.total_revenue or 0) }}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
                        <p class="text-lg font-semibold text-gray-900">{{ "%.2f"|format(analytics.total_revenue or 0) }} ‚ÇΩ</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h2>
            </div>
            
            {% if orders %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –ó–∞–∫–∞–∑
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –ö–ª–∏–µ–Ω—Ç
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –¢–æ–≤–∞—Ä
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –°—Ç–∞—Ç—É—Å
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –°—É–º–º–∞
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –î–∞—Ç–∞
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                QR-–∫–æ–¥
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                –î–µ–π—Å—Ç–≤–∏—è
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for order in orders %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ order.order_code[:4] }}...{{ order.order_code[-4:] }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    ID: {{ order.id }}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ order.customer_name }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {{ order.customer_phone }}
                                </div>
                                {% if order.customer_city and order.customer_city != 'custom' %}
                                <div class="text-xs text-gray-400">
                                    {{ order.customer_city }}
                                </div>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ order.product_name }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {{ order.quantity }} —à—Ç.
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if order.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif order.status == 'paid' %}bg-blue-100 text-blue-800
                                    {% elif order.status == 'ordered_not_paid' %}bg-yellow-100 text-yellow-800
                                    {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if order.status == 'ordered_not_paid' %}
                                        –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
                                    {% elif order.status == 'paid' %}
                                        –û–ø–ª–∞—á–µ–Ω
                                    {% elif order.status == 'completed' %}
                                        –í—ã–¥–∞–Ω
                                    {% elif order.status == 'cancelled' %}
                                        –û—Ç–º–µ–Ω–µ–Ω
                                    {% else %}
                                        {{ order.status }}
                                    {% endif %}
                                </span>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ "%.2f"|format(order.total_amount) }} ‚ÇΩ
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ order.created_at.strftime('%d.%m.%Y %H:%M') if order.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if order.has_qr %}
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center">
                                        <span class="text-xs text-gray-600">QR</span>
                                    </div>
                                    <span class="text-xs text-green-600">‚úì</span>
                                </div>
                                {% else %}
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center">
                                        <span class="text-xs text-gray-600">-</span>
                                    </div>
                                    <span class="text-xs text-gray-400">–ù–µ—Ç</span>
                                </div>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <a 
                                    href="/shop/admin/orders/{{ order.id }}"
                                    class="text-blue-600 hover:text-blue-900 mr-3"
                                >
                                    üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                </a>
                                
                                {% if order.status == 'ordered_not_paid' %}
                                <button 
                                    onclick="markAsPaid({{ order.id }})"
                                    class="text-green-600 hover:text-green-900"
                                >
                                    üí≥ –û–ø–ª–∞—á–µ–Ω
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="px-6 py-12 text-center">
                <div class="text-gray-400 mb-4">
                    <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</p>
            </div>
            {% endif %}
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="mt-8 flex justify-center space-x-4">
            <a 
                href="/shop/admin/qr-scanner"
                class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium"
            >
                üì± –°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–æ–≤
            </a>
            
            <a 
                href="/shop"
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
                üõç –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
            </a>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

function markAsPaid(orderId) {
    if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π?')) {
        fetch(`/shop/admin/orders/${orderId}/reserve`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π!');
                location.reload();
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        });
    }
}
</script>
{% endblock %}
