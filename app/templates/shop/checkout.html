{% extends "shop/base.html" %}

{% block title %}Оформление заказа{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-4">Оформление заказа</h1>
    <p class="text-gray-600">Заполните данные для оформления заказа</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Форма заказа -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">Данные клиента</h2>
        
        <!-- Отображение ошибок -->
        {% if request.query_params.get('error') %}
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
            <div class="flex">
                <i class="fas fa-exclamation-circle text-red-400 mt-1 mr-3"></i>
                <div>
                    <p class="text-sm text-red-700">{{ request.query_params.get('error') }}</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <form method="POST" action="/shop/checkout" class="space-y-6">
            <!-- Имя -->
            <div>
                <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                    Имя * <span class="text-red-500">*</span>
                </label>
                <input type="text" 
                       name="customer_name" 
                       id="customer_name" 
                       required
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Введите ваше имя">
            </div>
            
            <!-- Телефон -->
            <div>
                <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-2">
                    Номер телефона
                </label>
                <input type="tel" 
                       name="customer_phone" 
                       id="customer_phone" 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="+7 (999) 123-45-67"
                       value="+7">
                <p class="text-sm text-gray-500 mt-1">Формат: +7 (XXX) XXX-XX-XX</p>
            </div>
            
            <!-- Город -->
            <div>
                <label for="customer_city" class="block text-sm font-medium text-gray-700 mb-2">
                    Город
                </label>
                <select name="customer_city" 
                        id="customer_city" 
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Выберите город</option>
                    <option value="Грозный">Грозный</option>
                    <option value="Махачкала">Махачкала</option>
                    <option value="Хасавюрт">Хасавюрт</option>
                    <option value="custom">Другой</option>
                </select>
                <input type="text" 
                       name="customer_city_custom" 
                       id="customer_city_custom"
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2 hidden"
                       placeholder="Введите название города">
            </div>
            
            <!-- Способ оплаты -->
            <div>
                <label for="payment_method_id" class="block text-sm font-medium text-gray-700 mb-2">
                    Способ оплаты
                </label>
                <select name="payment_method_id" 
                        id="payment_method_id" 
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Выберите способ оплаты</option>
                    <option value="1">Перевод по СБП +1%</option>
                    <option value="2">Наличными на складе в Грозном</option>
                    <option value="3">Наличными в кассу в Махачкале</option>
                    <option value="4">Наличными в кассу в Назране</option>
                    <option value="5">Наличными в кассу в Хасавюрте</option>
                    <option value="6">Оплата по б/н на р/с ИП +7%</option>
                </select>
            </div>
            
            <!-- Кнопка оформления -->
            <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition-colors duration-200">
                <i class="fas fa-check mr-2"></i>
                Оформить заказ
            </button>
        </form>
        
        <!-- Предупреждение -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
            <div class="flex">
                <i class="fas fa-exclamation-triangle text-yellow-400 mt-1 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-yellow-800">Важная информация</h3>
                    <p class="text-sm text-yellow-700 mt-1">
                        Товар резервируется на 48 часов. Если заказ не будет оплачен в течение этого времени, резерв автоматически снимается.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- WhatsApp контакты -->
        <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-md">
            <div class="flex">
                <i class="fab fa-whatsapp text-green-500 mt-1 mr-3 text-xl"></i>
                <div>
                    <h3 class="text-sm font-medium text-green-800">Оплата через WhatsApp</h3>
                    <p class="text-sm text-green-700 mt-1">
                        Для оплаты напишите менеджеру в WhatsApp: 
                        <a href="https://wa.me/79993980159" target="_blank" class="font-medium hover:underline">+7 999 398-01-59</a> 
                        или 
                        <a href="https://wa.me/375293571197" target="_blank" class="font-medium hover:underline">+375 29 357-11-97</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Сводка заказа -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">Сводка заказа</h2>
        
        <!-- Товары -->
        <div class="space-y-4 mb-6">
            {% for item in cart.items %}
            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-md">
                <!-- Фото -->
                <div class="flex-shrink-0">
                    {% if item.main_photo_url %}
                    <img src="{{ item.main_photo_url }}" 
                         alt="{{ item.product_name }}"
                         class="w-12 h-12 object-cover object-center rounded">
                    {% else %}
                    <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Информация -->
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 truncate">
                        {{ item.product_name }}
                    </h4>
                    <p class="text-sm text-gray-500">
                        {{ item.quantity }} × {{ "%.2f"|format(item.unit_price_rub) }} ₽
                    </p>
                </div>
                
                <!-- Стоимость -->
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-900">
                        {{ "%.2f"|format(item.total_price) }} ₽
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Итого -->
        <div class="border-t border-gray-200 pt-4">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600">Количество товаров:</span>
                <span class="font-medium">{{ cart.total_items }}</span>
            </div>
            <div class="flex justify-between text-lg font-semibold text-gray-900">
                <span>Итого к оплате:</span>
                <span class="text-blue-600">{{ "%.2f"|format(cart.total_amount) }} ₽</span>
            </div>
        </div>
        
        <!-- Информация о доставке -->
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
            <div class="flex">
                <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-blue-800">Доставка</h3>
                    <p class="text-sm text-blue-700 mt-1">
                        Товары можно забрать на складе в Грозном или заказать доставку в другие города.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Назад к корзине -->
<div class="mt-8 text-center">
    <a href="/shop/cart" class="text-blue-600 hover:text-blue-800 font-medium">
        <i class="fas fa-arrow-left mr-2"></i>
        Вернуться к корзине
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const citySelect = document.getElementById('customer_city');
    const cityCustomInput = document.getElementById('customer_city_custom');
    const phoneInput = document.getElementById('customer_phone');
    
    // Обработка выбора города
    citySelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            cityCustomInput.classList.remove('hidden');
            cityCustomInput.required = true;
            // Очищаем значение основного селекта при выборе "другой"
            this.value = '';
        } else {
            cityCustomInput.classList.add('hidden');
            cityCustomInput.required = false;
            cityCustomInput.value = '';
        }
    });
    
    // При отправке формы заменяем значение города на введенный пользователем
    document.querySelector('form').addEventListener('submit', function(e) {
        if (cityCustomInput.value.trim() !== '') {
            // Создаем скрытое поле с правильным именем
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'customer_city';
            hiddenInput.value = cityCustomInput.value.trim();
            this.appendChild(hiddenInput);
        }
    });
    
    // Маска для телефона
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // Убираем +7 из начала если есть
        if (value.startsWith('7')) {
            value = value.substring(1);
        }
        
        // Ограничиваем длину
        if (value.length > 10) {
            value = value.substring(0, 10);
        }
        
        // Форматируем номер
        let formatted = '+7';
        if (value.length > 0) {
            formatted += ' (' + value.substring(0, 3);
            if (value.length > 3) {
                formatted += ') ' + value.substring(3, 6);
                if (value.length > 6) {
                    formatted += '-' + value.substring(6, 8);
                    if (value.length > 8) {
                        formatted += '-' + value.substring(8, 10);
                    }
                }
            }
        }
        
        e.target.value = formatted;
    });
    
    // Устанавливаем начальное значение
    phoneInput.value = '+7';
    
    // Обработка выбора способа оплаты для расчета процентов
    const paymentMethodSelect = document.getElementById('payment_method_id');
    const totalAmountElement = document.querySelector('.text-blue-600');
    
    paymentMethodSelect.addEventListener('change', function() {
        const selectedMethod = this.value;
        let totalAmount = parseFloat('{{ cart.total_amount }}');
        
        // Убираем старые проценты если есть
        const oldPercentage = document.querySelector('.payment-percentage');
        if (oldPercentage) {
            oldPercentage.remove();
        }
        
        if (selectedMethod === '1') { // СБП +1%
            const percentage = totalAmount * 0.01;
            totalAmount += percentage;
            showPercentage(percentage, '1%');
        } else if (selectedMethod === '6') { // Б/н на р/с ИП +7%
            const percentage = totalAmount * 0.07;
            totalAmount += percentage;
            showPercentage(percentage, '7%');
        }
        
        // Обновляем отображаемую сумму
        if (totalAmountElement) {
            totalAmountElement.textContent = totalAmount.toFixed(2) + ' ₽';
        }
    });
    
    function showPercentage(amount, percentage) {
        const totalSection = document.querySelector('.border-t.border-gray-200.pt-4');
        if (totalSection) {
            const percentageDiv = document.createElement('div');
            percentageDiv.className = 'flex justify-between text-sm mb-2 payment-percentage';
            percentageDiv.innerHTML = `
                <span class="text-gray-600">Комиссия (${percentage}):</span>
                <span class="font-medium text-red-600">+${amount.toFixed(2)} ₽</span>
            `;
            
            // Вставляем перед итоговой суммой
            const totalRow = totalSection.querySelector('.text-lg.font-semibold');
            if (totalRow) {
                totalSection.insertBefore(percentageDiv, totalRow);
            }
        }
    }
});
</script>
{% endblock %}
