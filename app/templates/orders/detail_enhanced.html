{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }} - –°–∏—Ä–∏—É—Å{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4 sm:py-8">
    <div class="max-w-6xl mx-auto">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 space-y-4 sm:space-y-0">
            <div class="flex items-center">
                <a href="/orders" class="text-blue-600 hover:text-blue-800 mr-4 text-sm sm:text-base">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º
                </a>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">–ó–∞–∫–∞–∑ #{{ order.id }}</h1>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <a href="/qr-scanner" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded inline-flex items-center justify-center text-sm">
                    üì∑ QR-—Å–∫–∞–Ω–µ—Ä
                </a>
                {% if current_user and current_user.role in ['admin', 'manager'] %}
                    <a href="/orders/{{ order.id }}/edit" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded text-sm">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê -->
        <div id="status_confirmation_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞</h3>
                    <p class="text-sm text-gray-600 mb-6">
                        –í—ã <strong>–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û</strong> –¥–æ–ª–∂–Ω—ã –≤—ã–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã!
                    </p>
                    
                    <form id="status_form" method="POST" action="/orders/{{ order.id }}/update-status" class="space-y-4">
                        <div>
                            <label for="new_status" class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</label>
                            <select name="new_status" id="new_status" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                                <option value="paid_issued">‚úÖ –í—ã–¥–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç—É</option>
                                <option value="paid_denied">‚ùå –ù–µ –≤—ã–¥–∞–Ω–æ (–æ—Ç–∫–∞–∑)</option>
                                <option value="in_transit">üöö –í –ø—É—Ç–∏ (—Ç–æ–≤–∞—Ä –Ω–µ –ø—Ä–∏–µ—Ö–∞–ª)</option>
                                <option value="on_order">‚è≥ –ü–æ–¥ –∑–∞–∫–∞–∑ (–æ–∂–∏–¥–∞–Ω–∏–µ)</option>
                            </select>
                        </div>
                        
                        <div id="denial_reason_container" class="hidden">
                            <label for="denial_reason" class="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ –≤ –≤—ã–¥–∞—á–µ</label>
                            <textarea name="denial_reason" id="denial_reason" rows="3" 
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ—á–µ–º—É —Ç–æ–≤–∞—Ä –Ω–µ –±—ã–ª –≤—ã–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç—É..."></textarea>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                            </button>
                            <button type="button" onclick="hideStatusModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-colors">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="lg:col-span-2 space-y-6">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h2>
                        <div class="flex items-center space-x-2">
                            {% if order.order_code %}
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                    –ö–æ–¥: {{ order.order_code }}
                                </span>
                            {% endif %}
                            <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium">
                                #{{ order.id }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.created_at.strftime('%d.%m.%Y %H:%M:%S') }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</label>
                            <div class="mt-1">
                                {% set status_display = order.auto_status if hasattr(order, 'auto_status') else order.status %}
                                {% if status_display == "in_transit" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-truck mr-1"></i>–í –ø—É—Ç–∏
                                    </span>
                                {% elif status_display == "on_order" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1"></i>–ü–æ–¥ –∑–∞–∫–∞–∑
                                    </span>
                                {% elif status_display == "unpaid" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-times-circle mr-1"></i>–ù–µ –æ–ø–ª–∞—á–µ–Ω
                                    </span>
                                {% elif status_display == "courier_grozny" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                                        <i class="fas fa-motorcycle mr-1"></i>–ö—É—Ä—å–µ—Ä—É –≤ –ì—Ä–æ–∑–Ω—ã–π
                                    </span>
                                {% elif status_display == "courier_mak" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                        <i class="fas fa-motorcycle mr-1"></i>–ö—É—Ä—å–µ—Ä—É –≤ –ú–∞—Ö–∞—á–∫–∞–ª—É
                                    </span>
                                {% elif status_display == "courier_khas" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-pink-100 text-pink-800">
                                        <i class="fas fa-motorcycle mr-1"></i>–ö—É—Ä—å–µ—Ä—É –≤ –•–∞—Å–∞–≤—é—Ä—Ç
                                    </span>
                                {% elif status_display == "self_pickup" %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-store mr-1"></i>–û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                        <i class="fas fa-question mr-1"></i>{{ status_display }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        {% if order.issued_at %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.issued_at.strftime('%d.%m.%Y %H:%M:%S') }}</p>
                        </div>
                        {% endif %}
                        {% if order.paid_at %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.paid_at.strftime('%d.%m.%Y %H:%M:%S') }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.customer_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.phone }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ì–æ—Ä–æ–¥</label>
                            <p class="mt-1 text-sm text-gray-900">{{ order.client_city or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <p class="mt-1 text-sm text-gray-900">
                                {% if order.delivery_option %}
                                    {{ order.delivery_display_name }}
                                {% else %}
                                    –ù–µ —É–∫–∞–∑–∞–Ω–æ
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.product_name }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.qty }} –µ–¥.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ "%.2f"|format(order.unit_price_rub) }} ‚ÇΩ</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium text-blue-600">{{ "%.2f"|format(order.qty * order.unit_price_rub) }} ‚ÇΩ</p>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üí≥ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                            <p class="mt-1 text-sm text-gray-900">
                                {% if order.payment_method_id == 1 %}
                                    –ü–µ—Ä–µ–≤–æ–¥ –ø–æ –°–ë–ü +1%
                                {% elif order.payment_method_id == 2 %}
                                    –ù–∞–ª–∏—á–Ω—ã–º–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –≤ –ì—Ä–æ–∑–Ω–æ–º
                                {% elif order.payment_method_id == 3 %}
                                    –ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å—É –≤ –ú–∞—Ö–∞—á–∫–∞–ª–µ
                                {% elif order.payment_method_id == 4 %}
                                    –ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å—É –≤ –ù–∞–∑—Ä–∞–Ω–µ
                                {% elif order.payment_method_id == 5 %}
                                    –ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å—É –≤ –•–∞—Å–∞–≤—é—Ä—Ç–µ
                                {% elif order.payment_method_id == 6 %}
                                    –û–ø–ª–∞—Ç–∞ –ø–æ –±/–Ω –Ω–∞ —Ä/—Å –ò–ü +7%
                                {% elif order.payment_method_id == 7 %}
                                    –ù–∞–ª–∏—á–Ω—ã–º –∫—É—Ä—å–µ—Ä—É
                                {% else %}
                                    –ù–µ —É–∫–∞–∑–∞–Ω–æ
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</label>
                            <div class="mt-1">
                                {% if order.paid_amount and order.paid_amount > 0 %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-1"></i>–û–ø–ª–∞—á–µ–Ω–æ
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-times-circle mr-1"></i>–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        {% if order.paid_amount %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium text-green-600">{{ "%.2f"|format(order.paid_amount) }} ‚ÇΩ</p>
                        </div>
                        {% endif %}
                        {% if order.delivery_cost_rub %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <p class="mt-1 text-sm text-gray-900 font-medium">{{ order.delivery_cost_rub }} ‚ÇΩ</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞ -->
                {% if order.qr_payload %}
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üì± QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞</h2>
                    <div class="text-center">
                        <div class="bg-gray-100 p-4 rounded-lg inline-block">
                            <img src="/api/qr/{{ order.qr_payload }}" alt="QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞" class="w-32 h-32">
                        </div>
                        <p class="text-sm text-gray-600 mt-2">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–∫–∞–∑—É</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –¥–µ–π—Å—Ç–≤–∏—è –∏ —Å—Ç–∞—Ç—É—Å -->
            <div class="space-y-6">
                <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–∫–∞–∑–æ–º -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">‚ö° –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–∫–∞–∑–æ–º</h2>
                    
                    <!-- –î–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø—É—Ç–∏ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º -->
                    {% if order.auto_status in ['in_transit', 'on_order'] %}
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-center">
                                <i class="fas fa-info-circle text-blue-500 text-2xl mb-2"></i>
                                <p class="text-blue-700 text-sm">
                                    <strong>–¢–æ–≤–∞—Ä –≤ –ø—É—Ç–∏</strong><br>
                                    –ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                                </p>
                            </div>
                        </div>
                    {% else %}
                        <!-- –î–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞–ª–∏—á–∏–∏ - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
                        <div class="space-y-3">
                            <button onclick="showStatusModal()" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-check-circle mr-2"></i>
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–¥–∞—á–∏
                            </button>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-2"></i>
                                    <div class="text-sm text-yellow-700">
                                        <strong>–í–∞–∂–Ω–æ:</strong> –°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ä–∞–±–æ—Ç–µ —Å –∑–∞–∫–∞–∑–æ–º
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
                    <div class="space-y-3">
                        <a href="/qr-scanner" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors inline-block text-center">
                            <i class="fas fa-qrcode mr-2"></i>
                            –û—Ç–∫—Ä—ã—Ç—å QR-—Å–∫–∞–Ω–µ—Ä
                        </a>
                        
                        <a href="/orders/{{ order.id }}/edit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors inline-block text-center">
                            <i class="fas fa-edit mr-2"></i>
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑
                        </a>
                        
                        <a href="/orders" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors inline-block text-center">
                            <i class="fas fa-list mr-2"></i>
                            –ö —Å–ø–∏—Å–∫—É –∑–∞–∫–∞–∑–æ–≤
                        </a>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–∞ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–∞</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">–°–æ–∑–¥–∞–Ω:</span>
                            <span class="text-sm font-medium">{{ order.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                        {% if order.issued_at %}
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">–í—ã–¥–∞–Ω:</span>
                            <span class="text-sm font-medium">{{ order.issued_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">–°—É–º–º–∞:</span>
                            <span class="text-sm font-medium text-blue-600">{{ "%.2f"|format(order.qty * order.unit_price_rub) }} ‚ÇΩ</span>
                        </div>
                        {% if order.delivery_cost_rub %}
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                            <span class="text-sm font-medium">{{ order.delivery_cost_rub }} ‚ÇΩ</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between border-t border-gray-200 pt-2">
                            <span class="text-sm font-medium">–ò—Ç–æ–≥–æ:</span>
                            <span class="text-sm font-medium text-green-600">{{ "%.2f"|format(order.total_with_delivery) }} ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
function showStatusModal() {
    document.getElementById('status_confirmation_modal').classList.remove('hidden');
}

// –°–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function hideStatusModal() {
    document.getElementById('status_confirmation_modal').classList.add('hidden');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
document.getElementById('new_status').addEventListener('change', function() {
    const denialReasonContainer = document.getElementById('denial_reason_container');
    const denialReasonInput = document.getElementById('denial_reason');
    
    if (this.value === 'paid_denied') {
        denialReasonContainer.classList.remove('hidden');
        denialReasonInput.required = true;
    } else {
        denialReasonContainer.classList.add('hidden');
        denialReasonInput.required = false;
        denialReasonInput.value = '';
    }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
window.addEventListener('beforeunload', function(e) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    const needsConfirmation = {{ 'true' if order.auto_status not in ['in_transit', 'on_order'] else 'false' }};
    
    if (needsConfirmation) {
        e.preventDefault();
        e.returnValue = '–í—ã –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.';
        return e.returnValue;
    }
});

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
document.addEventListener('DOMContentLoaded', function() {
    const needsConfirmation = {{ 'true' if order.auto_status not in ['in_transit', 'on_order'] else 'false' }};
    
    if (needsConfirmation) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            showStatusModal();
        }, 2000);
    }
});
</script>
{% endblock %}





