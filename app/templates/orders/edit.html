{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ #{{ order.id }} - –°–∏—Ä–∏—É—Å{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <a href="/orders/{{ order.id }}" class="text-blue-600 hover:text-blue-800 mr-4">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑—É
                </a>
                <h1 class="text-3xl font-bold text-gray-900">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ #{{ order.id }}</h1>
            </div>
            <a href="/qr-scanner" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                üì∑ QR-—Å–∫–∞–Ω–µ—Ä
            </a>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <form method="POST" class="space-y-6">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                                –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *
                            </label>
                            <input type="tel" name="phone" id="phone" value="{{ order.phone }}" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="+7 (999) 123-45-67">
                        </div>
                        <div>
                            <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-1">
                                –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
                            </label>
                            <input type="text" name="customer_name" id="customer_name" value="{{ order.customer_name or '' }}"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="product_id" class="block text-sm font-medium text-gray-700 mb-1">
                                –¢–æ–≤–∞—Ä *
                            </label>
                            <select name="product_id" id="product_id" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" 
                                        data-price="{{ product.sell_price_rub or 0 }}"
                                        data-stock="{{ product.stock }}"
                                        {% if product.id == order.product_id %}selected{% endif %}>
                                    {{ product.name }} (–æ—Å—Ç–∞—Ç–æ–∫: {{ product.stock }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *
                            </label>
                            <input type="number" name="qty" id="qty" min="1" value="{{ order.qty }}" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="1">
                        </div>
                        <div>
                            <label for="unit_price_rub" class="block text-sm font-medium text-gray-700 mb-1">
                                –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ) *
                            </label>
                            <input type="number" name="unit_price_rub" id="unit_price_rub" step="0.01" min="0" 
                                   value="{{ "%.2f"|format(order.unit_price_rub) }}" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</h4>
                    <div class="flex items-center">
                        {% if order.status == "paid_not_issued" %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                –û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏
                            </span>
                        {% elif order.status == "paid_issued" %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                –í—ã–¥–∞–Ω–æ
                            </span>
                        {% elif order.status == "paid_denied" %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                –û—Ç–º–µ–Ω–µ–Ω–æ
                            </span>
                        {% endif %}
                        <span class="ml-2 text-sm text-gray-500">
                            (–∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–∫–∞–∑–∞)
                        </span>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                            <span id="calc_qty" class="font-medium ml-2">{{ order.qty }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                            <span id="calc_price" class="font-medium ml-2">{{ "%.2f"|format(order.unit_price_rub) }} ‚ÇΩ</span>
                        </div>
                        <div class="col-span-2">
                            <span class="text-gray-600">–û–±—â–∞—è —Å—É–º–º–∞:</span>
                            <span id="calc_total" class="font-medium ml-2 text-lg text-blue-600">{{ "%.2f"|format(order.total_amount) }} ‚ÇΩ</span>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="flex justify-end space-x-4">
                    <a href="/orders/{{ order.id }}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product_id');
    const qtyInput = document.getElementById('qty');
    const priceInput = document.getElementById('unit_price_rub');
    
    const calcQty = document.getElementById('calc_qty');
    const calcPrice = document.getElementById('calc_price');
    const calcTotal = document.getElementById('calc_total');

    function updateCalculation() {
        const qty = parseInt(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = qty * price;

        calcQty.textContent = qty;
        calcPrice.textContent = price.toFixed(2) + ' ‚ÇΩ';
        calcTotal.textContent = total.toFixed(2) + ' ‚ÇΩ';
    }

    function updatePriceFromProduct() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        if (selectedOption && selectedOption.dataset.price) {
            const price = parseFloat(selectedOption.dataset.price);
            priceInput.value = price.toFixed(2);
            updateCalculation();
        }
    }

    productSelect.addEventListener('change', updatePriceFromProduct);
    qtyInput.addEventListener('input', updateCalculation);
    priceInput.addEventListener('input', updateCalculation);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateCalculation();
});
</script>
{% endblock %}
