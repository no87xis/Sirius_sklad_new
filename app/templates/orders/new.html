{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - –°–∏—Ä–∏—É—Å{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <a href="/orders" class="text-blue-600 hover:text-blue-800 mr-4">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º
                </a>
                <h1 class="text-3xl font-bold text-gray-900">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h1>
            </div>
            <a href="/qr-scanner" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                üì∑ QR-—Å–∫–∞–Ω–µ—Ä
            </a>
        </div>

        {% include "_flash.html" %}

        <div class="bg-white rounded-lg shadow p-6">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="text-lg font-medium text-blue-900 mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-1">–ö–æ–¥ –∑–∞–∫–∞–∑–∞</label>
                        <div class="text-2xl font-mono font-bold text-blue-600 bg-white px-3 py-2 rounded border">
                            <span id="order_code_display">–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                        <div class="text-lg font-medium text-green-600 bg-white px-3 py-2 rounded border">
                            –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                        </div>
                    </div>
                </div>
            </div>
            
            <form method="POST" action="/orders" class="space-y-6">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                 <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                                –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                            </label>
                            <input type="tel" name="phone" id="phone"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="+7 (999) 123-45-67" value="+7">
                            <p class="text-sm text-gray-500 mt-1">–§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX</p>
                        </div>
                        <div>
                            <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-1">
                                –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
                            </label>
                            <input type="text" name="customer_name" id="customer_name"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                        </div>
                        <div>
                            <label for="client_city" class="block text-sm font-medium text-gray-700 mb-1">
                                –ì–æ—Ä–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞
                            </label>
                            <select name="client_city" id="client_city" 
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                <option value="–ì—Ä–æ–∑–Ω—ã–π">–ì—Ä–æ–∑–Ω—ã–π</option>
                                <option value="–ú–∞—Ö–∞—á–∫–∞–ª–∞">–ú–∞—Ö–∞—á–∫–∞–ª–∞</option>
                                <option value="–•–∞—Å–∞–≤—é—Ä—Ç">–•–∞—Å–∞–≤—é—Ä—Ç</option>
                                <option value="custom">–î—Ä—É–≥–æ–π</option>
                            </select>
                            <input type="text" name="client_city_custom" id="client_city_custom"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2 hidden"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞">
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="product_id" class="block text-sm font-medium text-gray-700 mb-1">
                                –¢–æ–≤–∞—Ä *
                            </label>
                            <select name="product_id" id="product_id" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" 
                                        data-price="{{ product.sell_price_rub or 0 }}"
                                        data-stock="{{ product.stock }}">
                                    {{ product.name }} (–æ—Å—Ç–∞—Ç–æ–∫: {{ product.stock }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *
                            </label>
                            <input type="number" name="qty" id="qty" min="1" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="1" value="1">
                        </div>
                        <div>
                            <label for="unit_price_rub" class="block text-sm font-medium text-gray-700 mb-1">
                                –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ) *
                            </label>
                            <input type="number" name="unit_price_rub" id="unit_price_rub" step="0.01" min="0" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- –ö—É—Ä—Å –µ–≤—Ä–æ –∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">–ö—É—Ä—Å –µ–≤—Ä–æ –∏ –æ–ø–ª–∞—Ç–∞</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="eur_rate" class="block text-sm font-medium text-gray-700 mb-1">
                                –ö—É—Ä—Å –µ–≤—Ä–æ (‚ÇΩ) *
                            </label>
                            <input type="number" name="eur_rate" id="eur_rate" step="0.0001" min="0" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="90.0000" value="{{ "%.4f"|format(last_eur_rate) }}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã *
                            </label>
                            <div class="flex gap-2">
                                <button type="button" id="payment_paid" name="payment_status" value="paid"
                                        class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium transition-all duration-200 payment-status-btn"
                                        data-status="paid">
                                    üí∞ –û–ø–ª–∞—á–µ–Ω–æ
                                </button>
                                <button type="button" id="payment_unpaid" name="payment_status" value="unpaid"
                                        class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium transition-all duration-200 payment-status-btn active"
                                        data-status="unpaid">
                                    ‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ
                                </button>
                            </div>
                            <input type="hidden" name="payment_method" id="payment_method" value="unpaid" required>
                        </div>
                        <div>
                            <label for="payment_method_id" class="block text-sm font-medium text-gray-700 mb-1">
                                –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:
                            </label>
                            <select name="payment_method_id" id="payment_method_id"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</option>
                                <option value="1">–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –°–ë–ü +1%</option>
                                <option value="2">–ù–∞–ª–∏—á–Ω—ã–º–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –≤ –ì—Ä–æ–∑–Ω–æ–º</option>
                                <option value="3">–ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å—É –≤ –ú–∞—Ö–∞—á–∫–∞–ª–µ</option>
                                <option value="4">–ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å—É –≤ –ù–∞–∑—Ä–∞–Ω–µ</option>
                                <option value="5">–ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å—É –≤ –•–∞—Å–∞–≤—é—Ä—Ç–µ</option>
                                <option value="6">–û–ø–ª–∞—Ç–∞ –ø–æ –±/–Ω –Ω–∞ —Ä/—Å –ò–ü +7%</option>
                            </select>
                        </div>
                    </div>
                    <div id="payment_note_container" class="mt-4 hidden">
                        <label for="payment_note" class="block text-sm font-medium text-gray-700 mb-1">
                            –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –æ–ø–ª–∞—Ç–µ
                        </label>
                        <input type="text" name="payment_note" id="payment_note"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="–£–∫–∞–∂–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã">
                    </div>
                </div>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                            <span id="calc_qty" class="font-medium ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                            <span id="calc_price" class="font-medium ml-2">0.00 ‚ÇΩ</span>
                        </div>
                        <div class="col-span-2">
                            <span class="text-gray-600">–û–±—â–∞—è —Å—É–º–º–∞:</span>
                            <span id="calc_total" class="font-medium ml-2 text-lg text-blue-600">0.00 ‚ÇΩ</span>
                        </div>
                        <div class="col-span-2">
                            <span id="commission_info" class="text-sm text-orange-600 font-medium hidden"></span>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="flex justify-end space-x-4">
                    <a href="/orders" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.payment-status-btn {
    background-color: #f3f4f6;
    color: #374151;
    border-color: #d1d5db;
}

.payment-status-btn:hover {
    background-color: #e5e7eb;
    border-color: #9ca3af;
}

.payment-status-btn.active {
    background-color: #3b82f6;
    color: white;
    border-color: #2563eb;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
}

.payment-status-btn.active:hover {
    background-color: #2563eb;
    border-color: #1d4ed8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product_id');
    const qtyInput = document.getElementById('qty');
    const priceInput = document.getElementById('unit_price_rub');
    
    const calcQty = document.getElementById('calc_qty');
    const calcPrice = document.getElementById('calc_price');
    const calcTotal = document.getElementById('calc_total');

    function updateCalculation() {
        const qty = parseInt(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const paymentMethod = document.getElementById('payment_method_id').value;
        
        let finalPrice = price;
        let commission = 0;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–∏—Å—Å–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        if (paymentMethod === '1') { // –°–ë–ü +1%
            commission = price * 0.01;
            finalPrice = price + commission;
        } else if (paymentMethod === '6') { // —Ä/—Å –ò–ü +7%
            commission = price * 0.07;
            finalPrice = price + commission;
        }
        
        const total = qty * finalPrice;

        calcQty.textContent = qty;
        calcPrice.textContent = finalPrice.toFixed(2) + ' ‚ÇΩ';
        calcTotal.textContent = total.toFixed(2) + ' ‚ÇΩ';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
        if (commission > 0) {
            const commissionText = paymentMethod === '1' ? '–°–ë–ü +1%' : '—Ä/—Å –ò–ü +7%';
            document.getElementById('commission_info').textContent = `–ö–æ–º–∏—Å—Å–∏—è ${commissionText}: +${commission.toFixed(2)} ‚ÇΩ`;
            document.getElementById('commission_info').classList.remove('hidden');
        } else {
            document.getElementById('commission_info').classList.add('hidden');
        }
    }

    function updatePriceFromProduct() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        if (selectedOption && selectedOption.dataset.price) {
            const price = parseFloat(selectedOption.dataset.price);
            priceInput.value = price.toFixed(2);
            updateCalculation();
        }
    }

    productSelect.addEventListener('change', updatePriceFromProduct);
    qtyInput.addEventListener('input', updateCalculation);
    priceInput.addEventListener('input', updateCalculation);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏
    document.getElementById('payment_method_id').addEventListener('change', updateCalculation);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã (–∫–Ω–æ–ø–∫–∏)
    const paymentPaidBtn = document.getElementById('payment_paid');
    const paymentUnpaidBtn = document.getElementById('payment_unpaid');
    const paymentMethodHidden = document.getElementById('payment_method');
    
    function setPaymentStatus(status) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        paymentPaidBtn.classList.remove('active');
        paymentUnpaidBtn.classList.remove('active');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        if (status === 'paid') {
            paymentPaidBtn.classList.add('active');
            paymentMethodHidden.value = 'paid';
        } else {
            paymentUnpaidBtn.classList.add('active');
            paymentMethodHidden.value = 'unpaid';
        }
    }
    
    paymentPaidBtn.addEventListener('click', () => setPaymentStatus('paid'));
    paymentUnpaidBtn.addEventListener('click', () => setPaymentStatus('unpaid'));
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
    const citySelect = document.getElementById('client_city');
    const cityCustomInput = document.getElementById('client_city_custom');
    
    citySelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            cityCustomInput.classList.remove('hidden');
            cityCustomInput.required = true;
        } else {
            cityCustomInput.classList.add('hidden');
            cityCustomInput.required = false;
            cityCustomInput.value = '';
        }
    });
    
    // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneInput = document.getElementById('phone');
    
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // –£–±–∏—Ä–∞–µ–º +7 –∏–∑ –Ω–∞—á–∞–ª–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (value.startsWith('7')) {
            value = value.substring(1);
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        if (value.length > 10) {
            value = value.substring(0, 10);
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä
        let formatted = '+7';
        if (value.length > 0) {
            formatted += ' (' + value.substring(0, 3);
            if (value.length > 3) {
                formatted += ') ' + value.substring(3, 6);
                if (value.length > 6) {
                    formatted += '-' + value.substring(6, 8);
                    if (value.length > 8) {
                        formatted += '-' + value.substring(8, 10);
                    }
                }
            }
        }
        
        e.target.value = formatted;
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    phoneInput.value = '+7';
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    const paymentMethodSelect = document.getElementById('payment_method');
    const paymentNoteContainer = document.getElementById('payment_note_container');
    
    paymentMethodSelect.addEventListener('change', function() {
        if (this.value === 'other') {
            paymentNoteContainer.classList.remove('hidden');
        } else {
            paymentNoteContainer.classList.add('hidden');
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateCalculation();
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∑–∞–∫–∞–∑–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const code = generateOrderCode();
    document.getElementById('order_code_display').textContent = code;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    document.getElementById('order_code_display').classList.add('animate-pulse');
    
    // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        document.getElementById('order_code_display').classList.remove('animate-pulse');
    }, 2000);
});

function generateOrderCode() {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 –±—É–∫–≤—ã (—Å—Ç—Ä–æ—á–Ω—ã–µ)
    const letters = 'abcdefghijklmnopqrstuvwxyz';
    let result = '';
    for (let i = 0; i < 3; i++) {
        result += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º 5 —Ü–∏—Ñ—Ä
    for (let i = 0; i < 5; i++) {
        result += Math.floor(Math.random() * 10);
    }
    
    return result;
}
</script>
{% endblock %}
